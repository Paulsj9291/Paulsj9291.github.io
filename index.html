<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Pengurusan Asrama SK Batu Niah</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal-enter-active, .modal-leave-active { transition: opacity 0.3s ease; }
        .modal-enter-from, .modal-leave-to { opacity: 0; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-800 font-sans">

<div id="app" class="flex flex-col min-h-screen relative">

    <div v-if="isLoading" class="fixed inset-0 bg-black bg-opacity-70 flex flex-col items-center justify-center z-[60]">
        <div class="loader mb-4"></div>
        <span class="font-semibold text-white text-lg">{{ loadingText }}</span>
    </div>

    <transition name="modal"><div v-if="showPromoteModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"><div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6"><h3 class="font-bold text-lg mb-4">Naik Kelas: {{ promoteData.nama }}</h3><div v-if="promoteData.isGraduating" class="p-4 bg-green-100 rounded text-center mb-4">Tamat Darjah 6</div><div v-else><select v-model="promoteData.selectedClassType" class="w-full border p-2 rounded mb-4"><option value="Cemerlang">Cemerlang</option><option value="Gemilang">Gemilang</option></select></div><div class="flex justify-end gap-2"><button @click="showPromoteModal=false" class="px-4 py-2 text-gray-500">Batal</button><button @click="confirmPromote" class="px-4 py-2 bg-blue-600 text-white rounded">Sahkan</button></div></div></div></transition>
    <transition name="modal"><div v-if="showRemoveModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"><div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6"><h3 class="font-bold text-lg mb-4 text-red-700">Pengeluaran Pelajar</h3><p class="mb-4">Sebab <b>{{ selectedRemoveStudent?.nama }}</b> dikeluarkan:</p><div class="space-y-2"><button @click="confirmRemove('Masalah Disiplin')" class="w-full text-left px-4 py-2 border rounded hover:bg-red-50">1. Disiplin</button><button @click="confirmRemove('Pindah Sekolah')" class="w-full text-left px-4 py-2 border rounded hover:bg-yellow-50">2. Pindah</button><button @click="confirmRemove('Tamat Sekolah')" class="w-full text-left px-4 py-2 border rounded hover:bg-blue-50">3. Tamat Sekolah</button></div><button @click="showRemoveModal=false" class="mt-4 w-full text-gray-500">Batal</button></div></div></transition>
    <transition name="modal"><div v-if="showEditModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"><div class="bg-white rounded-lg w-full max-w-2xl p-6"><h3 class="font-bold text-lg mb-4">Edit Data</h3><form @submit.prevent="submitEdit" class="grid md:grid-cols-2 gap-4"><input v-model="editForm.nama" placeholder="Nama" class="border p-2 rounded"><input v-model="editForm.ic" placeholder="IC" class="border p-2 rounded"><input v-model="editForm.kelas" placeholder="Kelas" class="border p-2 rounded"><input v-model="editForm.namaBapa" placeholder="Bapa" class="border p-2 rounded"><input v-model="editForm.noTel" placeholder="Tel" class="border p-2 rounded"><div class="col-span-2 flex justify-end gap-2"><button type="button" @click="showEditModal=false" class="px-4 py-2 text-gray-500">Batal</button><button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">Simpan</button></div></form></div></div></transition>
    <transition name="modal"><div v-if="showDocModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"><div class="bg-white rounded-lg w-full max-w-md p-6"><h3 class="font-bold text-lg mb-4">Dokumen</h3><div class="space-y-2"><a :href="selectedDocStudent?.urlGambar" target="_blank" class="block text-center border p-2 rounded bg-gray-50 text-blue-600">Gambar</a><a :href="selectedDocStudent?.urlSijil" target="_blank" class="block text-center border p-2 rounded bg-gray-50 text-green-600">Sijil</a><a :href="selectedDocStudent?.urlIC" target="_blank" class="block text-center border p-2 rounded bg-gray-50 text-purple-600">IC Waris</a></div><button @click="showDocModal=false" class="mt-4 w-full bg-gray-200 py-2 rounded">Tutup</button></div></div></transition>

    <header class="bg-blue-900 text-white shadow-lg sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3 cursor-pointer" @click="goHome">
                <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center text-blue-900 font-bold border-2 border-yellow-400">SK</div>
                <div><h1 class="font-bold leading-tight">SK BATU NIAH</h1><p class="text-xs text-blue-200">e-Asrama (Online)</p></div>
            </div>
            <div v-if="currentUser.role === 'admin'" class="flex items-center gap-3">
                <span class="text-xs bg-blue-800 px-2 py-1 rounded hidden md:block">{{ currentUser.name }}</span>
                <button @click="logout" class="text-xs bg-red-600 hover:bg-red-700 px-3 py-1 rounded">Keluar</button>
            </div>
            <div v-else-if="currentView !== 'login_selection'">
                <button @click="goHome" class="text-sm hover:text-gray-300"><i class="fa-solid fa-house"></i> Utama</button>
            </div>
        </div>
    </header>

    <main class="flex-grow max-w-7xl mx-auto w-full px-4 py-8">
        
        <div v-if="currentView === 'login_selection'" class="flex flex-col items-center justify-center min-h-[60vh]">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-4xl">
                <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-blue-600">
                    <h3 class="text-xl font-bold mb-4 text-center text-blue-900">Unit Pengurusan</h3>
                    <form @submit.prevent="adminLogin" class="space-y-3">
                        <input v-model="loginForm.id" type="text" placeholder="ID" class="w-full border p-2 rounded">
                        <input v-model="loginForm.pass" type="password" placeholder="Kata Laluan" class="w-full border p-2 rounded">
                        <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded font-bold">Log Masuk</button>
                    </form>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-green-500">
                    <h3 class="text-xl font-bold mb-4 text-center text-green-800">Ibu Bapa</h3>
                    <form @submit.prevent="parentCheck" class="space-y-3">
                        <input v-model="parentSearchIC" type="text" placeholder="No. MyKid" class="w-full border p-2 rounded">
                        <button type="submit" class="w-full bg-green-600 text-white py-2 rounded font-bold">Semak Status</button>
                    </form>
                </div>
            </div>
        </div>

        <div v-if="currentView === 'admin_dashboard'">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-white p-4 rounded shadow border-l-4 border-blue-500"><p class="text-xs font-bold text-gray-500">BARU</p><p class="text-2xl font-bold">{{ newApplicants.length }}</p></div>
                <div class="bg-white p-4 rounded shadow border-l-4 border-green-500"><p class="text-xs font-bold text-gray-500">SEMASA</p><p class="text-2xl font-bold">{{ existingStudents.length }}</p></div>
                <div class="bg-white p-4 rounded shadow border-l-4 border-gray-500"><p class="text-xs font-bold text-gray-500">BEKAS PELAJAR</p><p class="text-2xl font-bold">{{ archivedStudents.length }}</p></div>
                <div class="bg-white p-4 rounded shadow cursor-pointer hover:bg-blue-50" @click="fetchStudents"><p class="text-xs font-bold text-gray-500">DATABASE</p><p class="text-sm font-bold text-blue-600 mt-1"><i class="fa-solid fa-rotate mr-1"></i> Refresh</p></div>
            </div>

            <div class="flex border-b mb-4 overflow-x-auto">
                <button @click="activeTab = 'new'" :class="activeTab === 'new' ? 'border-blue-600 bg-blue-50' : 'text-gray-500'" class="px-6 py-3 border-b-2 font-bold whitespace-nowrap">Permohonan Baru</button>
                <button @click="activeTab = 'current'" :class="activeTab === 'current' ? 'border-green-600 bg-green-50' : 'text-gray-500'" class="px-6 py-3 border-b-2 font-bold whitespace-nowrap">Pelajar Semasa</button>
                <button @click="activeTab = 'archive'" :class="activeTab === 'archive' ? 'border-gray-600 bg-gray-50' : 'text-gray-500'" class="px-6 py-3 border-b-2 font-bold whitespace-nowrap">Bekas Pelajar</button>
                <button @click="activeTab = 'add'" :class="activeTab === 'add' ? 'border-purple-600 bg-purple-50' : 'text-gray-500'" class="px-6 py-3 border-b-2 font-bold whitespace-nowrap">Daftar Baru</button>
                <button @click="activeTab = 'settings'" :class="activeTab === 'settings' ? 'border-orange-600 bg-orange-50 text-orange-700' : 'text-gray-500'" class="px-6 py-3 border-b-2 font-bold whitespace-nowrap"><i class="fa-solid fa-cog mr-2"></i>Tetapan Surat</button>
            </div>

            <div v-if="activeTab === 'current'" class="bg-white rounded shadow overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 text-sm"><thead class="bg-green-50"><tr><th class="px-4 py-2">Pelajar</th><th class="px-4 py-2">Info</th><th class="px-4 py-2">Tindakan</th></tr></thead><tbody><tr v-for="std in existingStudents" :key="std.ic"><td class="px-4 py-3 font-bold">{{std.nama}}<br><span class="text-xs font-normal text-gray-500">{{std.kelas}}</span></td><td class="px-4 py-3 text-xs">{{std.namaBapa}}<br>{{std.noTel}}</td><td class="px-4 py-3 flex gap-2"><button @click="openPromoteModal(std)" class="text-purple-600 border px-2 rounded"><i class="fa-solid fa-arrow-up"></i></button><button @click="openEditModal(std)" class="text-blue-600 border px-2 rounded"><i class="fa-solid fa-pen"></i></button><button @click="openRemoveModal(std)" class="text-red-600 border px-2 rounded"><i class="fa-solid fa-trash"></i></button><button @click="printLetter(std)" class="text-gray-600 border px-2 rounded"><i class="fa-solid fa-print"></i></button></td></tr></tbody></table>
            </div>
            
            <div v-if="activeTab === 'new'" class="bg-white rounded shadow overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 text-sm"><thead class="bg-blue-50"><tr><th>Pelajar</th><th>Dokumen</th><th>Tindakan</th></tr></thead><tbody><tr v-for="std in newApplicants"><td class="px-4 py-3">{{std.nama}}</td><td class="px-4 py-3"><button @click="openDocModal(std)" class="text-blue-600 underline">Lihat</button></td><td class="px-4 py-3"><button @click="updateStatus(std, 'Diterima')" class="bg-green-600 text-white px-2 rounded mr-1">Lulus</button><button @click="updateStatus(std, 'Ditolak')" class="bg-red-600 text-white px-2 rounded">Tolak</button></td></tr></tbody></table>
            </div>

            <div v-if="activeTab === 'archive'" class="bg-white rounded shadow overflow-x-auto"><table class="min-w-full divide-y divide-gray-200 text-sm"><thead class="bg-gray-100"><tr><th>Pelajar</th><th>Sebab</th></tr></thead><tbody><tr v-for="std in archivedStudents"><td class="px-4 py-3">{{std.nama}}</td><td class="px-4 py-3">{{std.sebabKeluar}}</td></tr></tbody></table></div>

            <div v-if="activeTab === 'add'" class="bg-white p-6 rounded shadow max-w-3xl mx-auto"><form @submit.prevent="handleFormSubmit" class="grid grid-cols-1 md:grid-cols-2 gap-4"><input v-model="form.nama" placeholder="Nama" class="border p-2 rounded"><input v-model="form.ic" placeholder="IC" class="border p-2 rounded"><input v-model="form.namaBapa" placeholder="Bapa" class="border p-2 rounded"><input v-model="form.noTel" placeholder="Tel" class="border p-2 rounded"><button type="submit" class="col-span-2 bg-blue-600 text-white py-2 rounded">Simpan</button></form></div>

            <div v-if="activeTab === 'settings'" class="bg-white p-6 rounded shadow max-w-4xl mx-auto">
                <h3 class="font-bold text-lg mb-6 border-b pb-2 text-orange-700">Tetapan Surat Tawaran</h3>
                
                <div class="grid md:grid-cols-2 gap-8">
                    <div>
                        <h4 class="font-bold text-sm mb-3">Maklumat Umum</h4>
                        <div class="mb-4">
                            <label class="block text-xs font-bold text-gray-600">Nama Guru Besar</label>
                            <input v-model="settings.guruBesar" class="w-full border p-2 rounded text-sm uppercase" placeholder="Contoh: JUTIE ANAK UGAK">
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-xs font-bold text-gray-600 mb-1">Jata Negara (Imej)</label>
                            <input type="file" @change="handleLogoUpload($event, 'logoJata')" accept="image/*" class="text-xs w-full mb-2">
                            <img v-if="settings.logoJata" :src="settings.logoJata" class="h-16 border p-1 rounded">
                        </div>

                        <div class="mb-4">
                            <label class="block text-xs font-bold text-gray-600 mb-1">Lencana Sekolah (Imej)</label>
                            <input type="file" @change="handleLogoUpload($event, 'logoLencana')" accept="image/*" class="text-xs w-full mb-2">
                            <img v-if="settings.logoLencana" :src="settings.logoLencana" class="h-16 border p-1 rounded">
                        </div>
                        <p class="text-[10px] text-gray-400 italic">* Sila guna imej kecil (bawah 50KB) untuk prestasi optimum.</p>
                    </div>

                    <div>
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="font-bold text-sm">Senarai Keperluan Asrama</h4>
                            <button @click="addItem" class="text-green-600 text-xs border border-green-600 px-2 py-1 rounded hover:bg-green-50">+ Tambah Item</button>
                        </div>
                        <div class="max-h-[400px] overflow-y-auto border rounded p-2 bg-gray-50">
                            <table class="w-full text-xs">
                                <thead><tr class="text-left text-gray-500"><th>Item</th><th class="w-16">Qty</th><th class="w-8"></th></tr></thead>
                                <tbody>
                                    <tr v-for="(item, index) in settings.keperluanList" :key="index" class="border-b">
                                        <td class="p-1"><input v-model="item.name" class="w-full bg-transparent border-none focus:bg-white p-1" placeholder="Nama Barang"></td>
                                        <td class="p-1"><input v-model="item.qty" class="w-full bg-transparent border-none focus:bg-white p-1" placeholder="1"></td>
                                        <td class="p-1 text-center"><button @click="removeItem(index)" class="text-red-500 hover:text-red-700"><i class="fa-solid fa-times"></i></button></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="mt-6 border-t pt-4 flex justify-end">
                    <button @click="saveSettings" class="bg-orange-600 text-white font-bold py-2 px-6 rounded shadow hover:bg-orange-700 flex items-center gap-2">
                        <i class="fa-solid fa-floppy-disk"></i> Simpan Tetapan
                    </button>
                </div>
            </div>
        </div>
        
        <div v-if="currentView === 'parent_result'" class="flex justify-center">
            <div class="bg-white w-full max-w-2xl p-8 rounded shadow-xl border-t-8 border-blue-900">
                <div class="text-center mb-6"><h2 class="text-2xl font-bold">Status Permohonan</h2><p class="text-gray-500 mt-1">{{ selectedStudent.nama }}</p></div>
                <div class="flex justify-center mb-8">
                    <div v-if="selectedStudent.status === 'Diterima'" class="bg-green-100 text-green-800 px-6 py-3 rounded font-bold border border-green-300">DITERIMA</div>
                    <div v-else-if="selectedStudent.status === 'Ditolak'" class="bg-red-100 text-red-800 px-6 py-3 rounded font-bold border border-red-300">TIDAK BERJAYA</div>
                    <div v-else class="bg-yellow-100 text-yellow-800 px-6 py-3 rounded font-bold border border-yellow-300">DALAM PROSES</div>
                </div>
                <button v-if="selectedStudent.status === 'Diterima'" @click="printLetter(selectedStudent)" class="w-full bg-blue-700 text-white font-bold py-3 rounded mb-4">CETAK SURAT TAWARAN</button>
                <button @click="currentView = 'login_selection'; parentSearchIC=''" class="w-full text-gray-500 underline">Kembali</button>
            </div>
        </div>
    </main>
</div>

<script>
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbxEIawdw97ci5tzPtqImOfX_hlIAtBY7y0pBwb7I96P_SWV81yTUYPJCNZrE9xgLAeo/exec'; 

    const { createApp } = Vue;
    const { jsPDF } = window.jspdf;

    createApp({
        data() {
            return {
                currentView: 'login_selection',
                activeTab: 'new',
                isLoading: false, loadingText: 'Sedang memproses...',
                showRemoveModal: false, showEditModal: false, showDocModal: false, showPromoteModal: false,
                
                loginForm: { id: '', pass: '' }, currentUser: { role: '', name: '' }, parentSearchIC: '',
                students: [], selectedStudent: null, selectedRemoveStudent: null, selectedDocStudent: null,
                
                promoteData: { ic: '', nama: '', currentClass: '', nextYearVal: '', selectedClassType: 'Cemerlang', isGraduating: false },
                entryType: 'new',
                form: { nama: '', ic: '', kelas: '', jantina: '', tahunMasuk: new Date().getFullYear(), agama: 'Islam', alamat: '', namaBapa: '', icBapa: '', noTel: '', alahan: 'Tiada', penyakit: 'Tiada' },
                files: { fileGambar: null, fileSijil: null, fileIC: null },
                editForm: {}, originalEditIC: '', generatedClasses: [], diseaseList: [], allergyList: [],

                // --- DATA TETAPAN ---
                settings: {
                    guruBesar: 'JUTIE ANAK UGAK',
                    logoJata: '', // Base64 string
                    logoLencana: '', // Base64 string
                    keperluanList: [
                        {name:'Baldi', qty:'1'}, {name:'Gayung/Pencedok Air', qty:'1'},
                        {name:'Berus Pakaian', qty:'1'}, {name:'Berus Kasut & Stoking', qty:'1'},
                        {name:'Bantal', qty:'1'}, {name:'Selimut', qty:'1'}, {name:'Sarung Bantal', qty:'1'},
                        {name:'Cadar Tilam', qty:'1'}, {name:'Kunci dan Mangga Almari', qty:'1'},
                        {name:'Seluar Sukan - Panjang', qty:'2'}, {name:'Baju Sukan', qty:'2'},
                        {name:'Kasut Sukan', qty:'1'}, {name:'Tuala Mandi', qty:'2'},
                        {name:'Pengetip Pakaian', qty:'10'}, {name:'Hanger Pakaian', qty:'10'},
                        {name:'Pewangi Almari', qty:'1'}, {name:'Minyak Angin', qty:'1'},
                        {name:'Tisu', qty:'1'}, {name:'Lampu Suluh', qty:'1'},
                        {name:'Payung/Baju Hujan', qty:'1'}, {name:'Sudu/Garpu/Cawan/Mangkuk', qty:'1 Set'},
                        {name:'Botol Air & Bekas Makanan', qty:'1 Set'}, {name:'Selipar', qty:'1'}
                    ]
                }
            }
        },
        computed: {
            newApplicants() { return this.students.filter(s => s.status === 'Baru' || s.status === 'Simpanan'); },
            existingStudents() { return this.students.filter(s => s.status === 'Diterima'); },
            archivedStudents() { return this.students.filter(s => s.status === 'Bekas Pelajar'); },
            kivStudents() { return this.students.filter(s => s.status === 'Simpanan'); }
        },
        mounted() { this.generateClassList(); },
        methods: {
            // --- SETTINGS LOGIC ---
            async fetchSettings() {
                try {
                    const res = await fetch(GAS_URL + '?action=readSettings');
                    const json = await res.json();
                    if (json.result === 'success' && Object.keys(json.data).length > 0) {
                        const s = json.data;
                        if(s.guruBesar) this.settings.guruBesar = s.guruBesar;
                        if(s.logoJata) this.settings.logoJata = s.logoJata;
                        if(s.logoLencana) this.settings.logoLencana = s.logoLencana;
                        if(s.keperluanList) this.settings.keperluanList = JSON.parse(s.keperluanList);
                    }
                } catch(e) { console.log('Guna default settings'); }
            },
            async saveSettings() {
                this.isLoading = true; this.loadingText = "Menyimpan tetapan...";
                const params = new URLSearchParams();
                params.append('action', 'saveSettings');
                params.append('guruBesar', this.settings.guruBesar);
                params.append('logoJata', this.settings.logoJata);
                params.append('logoLencana', this.settings.logoLencana);
                params.append('keperluanList', JSON.stringify(this.settings.keperluanList));
                try { await fetch(GAS_URL, {method:'POST', mode:'no-cors', body:params}); alert('Tetapan disimpan!'); } catch(e){ alert('Ralat simpan'); } finally { this.isLoading = false; }
            },
            handleLogoUpload(event, key) {
                const file = event.target.files[0];
                if(file) {
                    if(file.size > 50000) { alert('Sila guna logo bawah 50KB untuk kelancaran.'); return; }
                    const reader = new FileReader();
                    reader.onload = (e) => { this.settings[key] = e.target.result; };
                    reader.readAsDataURL(file);
                }
            },
            addItem() { this.settings.keperluanList.push({name:'', qty:'1'}); },
            removeItem(index) { this.settings.keperluanList.splice(index, 1); },

            // --- STANDARD LOGIC ---
            goHome() { this.currentView = 'login_selection'; }, logout() { this.goHome(); },
            generateClassList() { const years = ['1', '2', '3', '4', '5', '6']; const names = ['Cemerlang', 'Gemilang']; this.generatedClasses = []; years.forEach(y => { names.forEach(n => { this.generatedClasses.push(`${y} ${n}`); }); }); },
            autoDetectGender(target) { const source = target === 'form' ? this.form : this.editForm; const ic = source.ic.replace(/[^0-9]/g, ''); if (ic.length === 12) { source.jantina = (parseInt(ic.slice(-1)) % 2 !== 0) ? 'Lelaki' : 'Perempuan'; } },
            calculateDuration(year) { if(!year) return 'Baru'; const diff = new Date().getFullYear() - parseInt(year); return diff === 0 ? '< 1 Tahun' : `${diff} Tahun`; },
            formatDate(dateStr) { if(!dateStr) return '-'; return new Date(dateStr).toLocaleDateString('ms-MY'); },
            populateLists() { const diseases = new Set(['Tiada']); const allergies = new Set(['Tiada']); this.students.forEach(s => { if (s.penyakit) diseases.add(s.penyakit); if (s.alahan) allergies.add(s.alahan); }); this.diseaseList = Array.from(diseases); this.allergyList = Array.from(allergies); },
            
            openPromoteModal(std) { const parts = std.kelas.split(' '); const currentYear = parseInt(parts[0]); this.promoteData.ic = std.ic; this.promoteData.nama = std.nama; this.promoteData.currentClass = std.kelas; if (!isNaN(currentYear)) { const next = currentYear + 1; if (next > 6) { this.promoteData.isGraduating = true; this.promoteData.nextYearVal = 'Tamat'; } else { this.promoteData.isGraduating = false; this.promoteData.nextYearVal = next; this.promoteData.selectedClassType = std.kelas.includes("Gemilang") ? "Gemilang" : "Cemerlang"; } } else { alert('Format kelas salah.'); return; } this.showPromoteModal = true; },
            async confirmPromote() { this.isLoading = true; if (this.promoteData.isGraduating) { await this.silentRemove({ic: this.promoteData.ic}, "Tamat Darjah 6"); this.showPromoteModal = false; this.isLoading = false; alert("Pelajar tamat sekolah."); this.fetchStudents(); return; } const newClass = `${this.promoteData.nextYearVal} ${this.promoteData.selectedClassType}`; const params = new URLSearchParams(); params.append('action', 'updateStudent'); params.append('original_ic', this.promoteData.ic); const std = this.students.find(s => s.ic === this.promoteData.ic); if(std) { std.kelas = newClass; for (const key in std) { if(['nama','ic','kelas','jantina','agama','alamat','namaBapa','icBapa','noTel','alahan','penyakit'].includes(key)) params.append(key, std[key]); } try { await fetch(GAS_URL, { method: 'POST', mode: 'no-cors', body: params }); alert(`Naik ke ${newClass}`); this.showPromoteModal = false; setTimeout(() => { this.fetchStudents(); }, 1500); } catch(e) { alert('Ralat'); } } this.isLoading = false; },

            async fetchStudents() { if (GAS_URL.includes('LETAKKAN')) { alert('Masukkan URL Script!'); return; } this.isLoading = true; try { const res = await fetch(GAS_URL + '?action=read'); const json = await res.json(); if (json.result === 'success') { this.students = json.data; this.populateLists(); this.checkAutoGraduation(); this.fetchSettings(); /* Fetch settings too */ } } catch (e) { console.error(e); } finally { this.isLoading = false; } },
            async handleFormSubmit() { this.isLoading = true; this.loadingText = "Muat naik dokumen..."; let urlGambar = '', urlSijil = '', urlIC = ''; try { if (this.files.fileGambar) urlGambar = await this.uploadSingleFile(this.files.fileGambar, `Gambar_${this.form.nama}`); if (this.files.fileSijil) urlSijil = await this.uploadSingleFile(this.files.fileSijil, `Sijil_${this.form.nama}`); if (this.files.fileIC) urlIC = await this.uploadSingleFile(this.files.fileIC, `ICWaris_${this.form.nama}`); this.loadingText = "Simpan data..."; const params = new URLSearchParams(); params.append('action', 'insert'); for (const key in this.form) params.append(key, this.form[key]); params.append('status', this.entryType === 'existing' ? 'Diterima' : 'Baru'); params.append('urlGambar', urlGambar); params.append('urlSijil', urlSijil); params.append('urlIC', urlIC); await fetch(GAS_URL, { method: 'POST', mode: 'no-cors', body: params }); alert('Berjaya!'); this.form = { nama: '', ic: '', kelas: '', jantina: '', tahunMasuk: new Date().getFullYear(), agama: 'Islam', alamat: '', namaBapa: '', icBapa: '', noTel: '', alahan: 'Tiada', penyakit: 'Tiada' }; this.files = { fileGambar: null, fileSijil: null, fileIC: null }; setTimeout(() => { this.fetchStudents(); }, 2000); } catch (e) { alert('Ralat'); } finally { this.isLoading = false; } },
            
            handleFile(event, key) { const file = event.target.files[0]; if (file && file.size < 2*1024*1024) this.files[key] = file; },
            toBase64(file) { return new Promise((res, rej) => { const r = new FileReader(); r.readAsDataURL(file); r.onload = () => res(r.result.split(',')[1]); r.onerror = e => rej(e); }); },
            async uploadSingleFile(file, name) { const b64 = await this.toBase64(file); const p = new URLSearchParams({action:'upload', base64:b64, mimeType:file.type, filename:name}); const r = await fetch(GAS_URL, {method:'POST', body:p}); const j = await r.json(); return j.url; },
            openDocModal(std) { this.selectedDocStudent = std; this.showDocModal = true; },
            checkAutoGraduation() { const cy = new Date().getFullYear(); this.existingStudents.forEach(std => { const y = parseInt(std.ic.substring(0,2)); const fy = y > 50 ? 1900+y : 2000+y; if (cy - fy >= 13) this.silentRemove(std, 'Tamat Darjah 6'); }); },
            async silentRemove(std, reason) { try { await fetch(`${GAS_URL}?action=updateStatus&ic=${std.ic}&status=Bekas Pelajar&sebabKeluar=${encodeURIComponent(reason)}`, {mode:'no-cors'}); } catch(e){} },
            openRemoveModal(std) { this.selectedRemoveStudent = std; this.showRemoveModal = true; },
            async confirmRemove(r) { this.isLoading = true; try { await fetch(`${GAS_URL}?action=updateStatus&ic=${this.selectedRemoveStudent.ic}&status=Bekas Pelajar&sebabKeluar=${encodeURIComponent(r)}`, {mode:'no-cors'}); this.showRemoveModal = false; this.fetchStudents(); } catch(e){} finally { this.isLoading = false; } },
            openEditModal(std) { this.originalEditIC = std.ic; this.editForm = {...std}; this.showEditModal = true; },
            async submitEdit() { this.isLoading = true; const p = new URLSearchParams({action:'updateStudent', original_ic:this.originalEditIC}); for(const k in this.editForm) p.append(k, this.editForm[k]); try { await fetch(GAS_URL, {method:'POST', mode:'no-cors', body:p}); this.showEditModal = false; setTimeout(() => this.fetchStudents(), 1500); } catch(e){} finally { this.isLoading = false; } },
            async adminLogin() { if ((this.loginForm.id === '01115864913' && this.loginForm.pass === '01115864913') || this.loginForm.pass === 'Ybb4412') { this.currentUser = {role:'admin', name:'Admin'}; this.currentView = 'admin_dashboard'; await this.fetchStudents(); } else alert('Login Salah.'); },
            async updateStatus(std, st) { if(confirm('Tukar status?')) { this.isLoading = true; await fetch(`${GAS_URL}?action=updateStatus&ic=${std.ic}&status=${st}`, {mode:'no-cors'}); setTimeout(() => this.fetchStudents(), 1000); this.isLoading = false; } },
            async parentCheck() { if(!this.students.length) await this.fetchStudents(); const inp = this.parentSearchIC.replace(/[^a-zA-Z0-9]/g, '').toLowerCase(); const f = this.students.find(s => String(s.ic).replace(/[^a-zA-Z0-9]/g, '').toLowerCase() === inp); if(f) { this.selectedStudent = f; this.currentView = 'parent_result'; } else alert('Tiada rekod.'); },
            
            // --- PRINT LETTER (DYNAMIC) ---
            printLetter(std) {
                const doc = new jsPDF();
                
                // HEADER (LOGO)
                if (this.settings.logoJata) doc.addImage(this.settings.logoJata, 'JPEG', 20, 10, 20, 15);
                if (this.settings.logoLencana) doc.addImage(this.settings.logoLencana, 'JPEG', 170, 10, 20, 20);

                doc.setFont("times", "bold"); doc.setFontSize(14);
                doc.text("SEKOLAH KEBANGSAAN BATU NIAH", 105, 15, null, null, "center");
                doc.setFont("times", "normal"); doc.setFontSize(10);
                doc.text("D/A PEJABAT PENDIDIKAN DAERAH SUBIS, 98150 BEKENU", 105, 20, null, null, "center");
                doc.text("YBB 4412", 105, 25, null, null, "center");
                doc.text("Tel: 085-737-005 | E-mel: skbatuniah@gmail.com", 105, 30, null, null, "center");
                doc.setLineWidth(0.5); doc.line(20, 35, 190, 35);

                doc.setFontSize(10);
                doc.text("Ruj. Kami: SKBN.T.700-10/2/1 (25)", 140, 45);
                const bt = new Date().toLocaleDateString('ms-MY', { month: 'long', year: 'numeric' });
                doc.text(`Tarikh: ${bt}`, 140, 50);

                doc.text(std.namaBapa || "Ibu Bapa / Penjaga", 20, 55);
                const addr = doc.splitTextToSize(std.alamat || "Alamat", 80); doc.text(addr, 20, 60);

                let cy = 85; doc.text("Tuan / Puan,", 20, cy); cy += 10;
                doc.setFont("times", "bold"); doc.text("Tawaran Masuk Ke Asrama SK Batu Niah bagi Sesi Tahun 2024-2025", 20, cy);
                doc.setLineWidth(0.2); doc.line(20, cy+2, 130, cy+2); cy += 10;

                doc.setFont("times", "normal");
                doc.text("Dengan segala hormatnya, saya merujuk kepada perkara di atas.", 20, cy); cy += 10;
                const p2 = `2.  Sukacita dimaklumkan bahawa anak jagaan Tuan, ${std.nama}, dari kelas ${std.kelas} bernombor kad pengenalan ${std.ic} telah ditawarkan menduduki asrama SK Batu Niah bagi sesi Tahun 2024-2025.`;
                const lp2 = doc.splitTextToSize(p2, 170); doc.text(lp2, 20, cy); cy += (lp2.length*6)+5;
                const p3 = "3.  Pihak Puan boleh menghubungi Warden Asrama, Cikgu Pauline Buyong (011-6488-2868) atau Penyelia Asrama, Jason anak James (0111-586-4913) untuk sebarang pertanyaan.";
                const lp3 = doc.splitTextToSize(p3, 170); doc.text(lp3, 20, cy); cy += (lp3.length*6)+5;
                const p4 = "4.  Perhatian dan kerjasama pihak Tuan di dalam perkara ini adalah dihargai dan didahului dengan ucapan terima kasih.";
                const lp4 = doc.splitTextToSize(p4, 170); doc.text(lp4, 20, cy); cy += 20;

                doc.setFont("times", "bold"); doc.text('"BERKHIDMAT UNTUK NEGARA"', 20, cy); cy += 10;
                doc.setFont("times", "normal"); doc.text("Saya yang menjalankan amanah,", 20, cy); cy += 20;
                doc.setFont("times", "bold"); doc.text(`(${this.settings.guruBesar})`, 20, cy); // DYNAMIC NAME
                doc.setFont("times", "normal"); doc.text("Guru Besar,", 20, cy+5); doc.text("SK Batu Niah", 20, cy+10);

                doc.setFontSize(8); doc.setFont("times", "italic");
                doc.text('"MENJULANG PENDIDIKAN NEGERI SARAWAK"', 105, 280, null, null, "center");
                doc.text('"FLY KENYALANG FLY, FLY HIGH"', 105, 285, null, null, "center");

                doc.addPage();
                doc.setFontSize(12); doc.setFont("times", "bold");
                doc.text("SENARAI KEPERLUAN PELAJAR ASRAMA", 105, 20, null, null, "center");

                // DYNAMIC LIST
                const headers = [['Bil', 'Jenis Keperluan', 'Kuantiti', 'Catatan']];
                const listData = this.settings.keperluanList.map((item, i) => [i+1, item.name, item.qty, '']);
                
                doc.autoTable({ head: headers, body: listData, startY: 30, theme: 'grid', headStyles: { fillColor: [0, 0, 0] }, styles: { fontSize: 9 } });
                let finalY = doc.lastAutoTable.finalY + 10;
                doc.setFont("times", "normal"); doc.text("Nota: Sila labelkan nama pelajar pada setiap peralatan.", 14, finalY);

                doc.autoPrint(); window.open(doc.output('bloburl'), '_blank');
            }
        }
    }).mount('#app');
</script>
</body>
</html>
